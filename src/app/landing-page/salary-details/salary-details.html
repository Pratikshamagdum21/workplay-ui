<div class="employee-list-container">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>
    <!-- Page Header -->
    <div class="flex justify-content-between align-items-center mb-4">
        <div class="page-header">
            <h1>
                <i class="pi pi-money-bill"></i> Salary Management
            </h1>
            <p class="subtitle">Process employee salaries - weekly and monthly</p>
        </div>
        <div class="flex gap-2">
            <div class="header-actions">
                <p-button label="Pay Salary" icon="pi pi-plus" severity="success" (onClick)="openPaySalaryDialog()">
                </p-button>
            </div>
            <div class="header-actions">
                <p-button label="Add Expenses" icon="pi pi-plus" severity="success" (onClick)="openAddExpensesDialog()">
                </p-button>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <p-card header="Filters & Reports" styleClass="filter-card mb-3">
        <div class="grid">
            <div class="col-12 md:col-4">
                <label for="filterSelect" class="filter-label">
                    <i class="pi pi-filter"></i> Filter By Period
                </label>
                <p-select id="filterSelect" [(ngModel)]="selectedFilter" [options]="filterOptions" optionLabel="label" optionValue="value" placeholder="Select filter" styleClass="w-full" (onChange)="onFilterChange($event)">
                </p-select>
            </div>

            <div class="col-12 md:col-5" *ngIf="showCustomDatePicker">
                <label for="customDate" class="filter-label">
                    <i class="pi pi-calendar"></i> Custom Date Range
                </label>
                <p-datepicker id="customDate" [(ngModel)]="customDateRange" selectionMode="range" [showIcon]="true" dateFormat="dd/mm/yy" placeholder="Select date range" styleClass="w-full" (onSelect)="onCustomDateChange()">
                </p-datepicker>
            </div>

            <div class="col-12 md:col-3 flex align-items-end gap-2">
                <p-button label="Clear Filter" icon="pi pi-filter-slash" severity="secondary" [outlined]="true" styleClass="w-full" (onClick)="clearFilter()">
                </p-button>
                <p-button label="Generate PDF" icon="pi pi-file-pdf" severity="danger" styleClass="w-full" (onClick)="generatePDFReport()">
                </p-button>
            </div>
        </div>

        <!-- Filter Summary -->
        <div class="filter-summary mt-3" *ngIf="selectedFilter !== 'all'">
            <i class="pi pi-info-circle"></i>
            <span>{{ filteredEmployees.length }} records found</span>
        </div>
    </p-card>

    <!-- Statistics Cards -->
    <div class="statistics-section">
        <div class="grid">
            <div class="col-12 md:col-3">
                <p-card styleClass="stat-card">
                    <div class="stat-content">
                        <i class="pi pi-list stat-icon"></i>
                        <div class="stat-details">
                            <span class="stat-label">Total Employees</span>
                            <span class="stat-value">{{ filteredEmployees.length }}</span>
                        </div>
                    </div>
                </p-card>
            </div>
            <div class="col-12 md:col-3">
                <p-card styleClass="stat-card">
                    <div class="stat-content">
                        <i class="pi pi-gift stat-icon" style="color: #22c55e;"></i>
                        <div class="stat-details">
                            <span class="stat-label">With Per-Salary Bonus</span>
                            <span class="stat-value">{{ getBonusedCount() }}</span>
                        </div>
                    </div>
                </p-card>
            </div>
            <div class="col-12 md:col-3">
                <p-card styleClass="stat-card">
                    <div class="stat-content">
                        <i class="pi pi-money-bill stat-icon" style="color: #6366f1;"></i>
                        <div class="stat-details">
                            <span class="stat-label">Total Salary Paid</span>
                            <span class="stat-value" style="font-size: 1rem;">{{ formatCurrency(totalSalaryPaid) }}</span>
                        </div>
                    </div>
                </p-card>
            </div>
            <div class="col-12 md:col-3">
                <p-card styleClass="stat-card">
                    <div class="stat-content">
                        <i class="pi pi-wallet stat-icon" style="color: #ef4444;"></i>
                        <div class="stat-details">
                            <span class="stat-label">Total Expenses</span>
                            <span class="stat-value" style="font-size: 1rem;">{{ formatCurrency(getTotalExpenses()) }}</span>
                        </div>
                    </div>
                </p-card>
            </div>
        </div>
    </div>

    <!-- Employee Table -->
    <p-card header="Employee Salary Overview" styleClass="employee-card">
        <p-table [value]="filteredEmployees" [loading]="loading" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]" [showCurrentPageReport]="true" currentPageReportTemplate="Showing {first} to {last} of {totalRecords} records" styleClass="p-datatable-striped"
            [tableStyle]="{ 'min-width': '480px' }" [scrollable]="true">

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="name">
                        Employee Name
                        <p-sortIcon field="name"></p-sortIcon>
                    </th>
                    <th pSortableColumn="salaryType">
                        Salary Type
                        <p-sortIcon field="salaryType"></p-sortIcon>
                    </th>
                    <th>Rate / Salary</th>
                    <th pSortableColumn="advanceTaken" class="text-right">
                        Advance Taken
                        <p-sortIcon field="advanceTaken"></p-sortIcon>
                    </th>
                    <th pSortableColumn="advanceRemaining" class="text-right">
                        Advance Remaining
                        <p-sortIcon field="advanceRemaining"></p-sortIcon>
                    </th>
                    <th>Bonus Type</th>
                    <th class="text-right">
                        Year-End Bonus ({{ currentYear }})
                        <!-- <p-tooltip value="For 'Without Bonus' employees: (Total {{ currentYear }} Salary / 100) × 16.66. For 'With Bonus' employees, bonus is paid each salary cycle." tooltipPosition="top"></p-tooltip> -->
                    </th>
                    <th class="text-center">Action</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-employee>
                <tr>
                    <td>
                        <div class="employee-name">
                            <i class="pi pi-user"></i> {{ employee.name }}
                        </div>
                    </td>
                    <td>
                        <p-tag [value]="getSalaryTypeLabel(employee.salaryType)" [severity]="getSalaryTypeSeverity(employee.salaryType)">
                        </p-tag>
                    </td>
                    <td>
                        <span *ngIf="employee.salaryType === 'WEEKLY'" class="rate-info">
                            {{ formatCurrency(employee.rate || 0) }}/meter
                        </span>
                        <span *ngIf="employee.salaryType === 'MONTHLY'" class="salary-info">
                            {{ formatCurrency(employee.salary || 0) }}/month
                        </span>
                    </td>
                    <td class="text-right">
                        <span class="advance-taken">{{ formatCurrency(employee.advanceTaken) }}</span>
                    </td>
                    <td class="text-right">
                        <span class="advance-remaining">{{ formatCurrency(employee.advanceRemaining) }}</span>
                    </td>
                    <td>
                        <p-tag [value]="getBonusLabel(employee.isBonused)" [severity]="getBonusSeverity(employee.isBonused)">
                        </p-tag>
                    </td>
                    <td class="text-right">
                        <!-- isBonused = true: paid each salary cycle, show "-" in year-end column -->
                        <span *ngIf="employee.isBonused" class="year-end-na" title="Bonus is paid each salary cycle (16.66% per payout)">
                            <i class="pi pi-check-circle" style="color:#22c55e; margin-right:4px;"></i>Per cycle
                        </span>
                        <!-- isBonused = false: show year-end bonus calculation -->
                        <ng-container *ngIf="!employee.isBonused">
                            <div class="year-end-bonus-cell">
                                <span class="year-end-bonus-amount">{{ formatCurrency(getYearEndBonus(employee)) }}</span>
                                <small class="year-end-ytd">YTD: {{ formatCurrency(getYearToDateSalary(employee)) }}</small>
                            </div>
                        </ng-container>
                    </td>
                    <td class="text-center">
                        <p-button label="Pay" icon="pi pi-money-bill" severity="success" size="small" (onClick)="openPaySalaryDialog()">
                        </p-button>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="empty-state">
                            <i class="pi pi-inbox"></i>
                            <p>No records found for the selected filter</p>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-card>

    <!-- Expense Records -->
    <p-card styleClass="year-end-summary-card mt-3" *ngIf="true">
        <ng-template pTemplate="header">
            <div class="flex justify-content-between align-items-center px-3 pt-3">
                <span class="font-semibold text-lg"><i class="pi pi-wallet mr-2"></i>Expense Records</span>
                <span class="font-bold text-primary">Total: {{ formatCurrency(getTotalExpenses()) }}</span>
            </div>
        </ng-template>
        <p-table [value]="expenditures" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]" [showCurrentPageReport]="true" currentPageReportTemplate="Showing {first} to {last} of {totalRecords} expenses" [tableStyle]="{ 'min-width': '40rem' }" styleClass="p-datatable-striped">
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 20%">Date</th>
                    <th style="width: 25%">Expense Type</th>
                    <th style="width: 25%" class="text-right">Amount</th>
                    <th style="width: 20%">Note</th>
                    <th style="width: 10%" class="text-center">Actions</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-exp>
                <tr>
                    <td>{{ exp.id.date }}</td>
                    <td>
                        <p-tag [value]="exp.id.expenseType" severity="warn"></p-tag>
                    </td>
                    <td class="text-right font-bold">{{ formatCurrency(exp.amount) }}</td>
                    <td>{{ exp.note || '—' }}</td>
                    <td class="text-center">
                        <p-button icon="pi pi-trash" severity="danger" [text]="true" [rounded]="true" pTooltip="Delete Expense" tooltipPosition="top" (onClick)="confirmDeleteExpenditure(exp)">
                        </p-button>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="5" class="text-center">
                        <div class="empty-state">
                            <i class="pi pi-inbox"></i>
                            <p>No expense records found</p>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="footer">
                <tr>
                    <td colspan="2" class="font-bold">Total Expenses</td>
                    <td class="text-right font-bold text-primary">{{ formatCurrency(getTotalExpenses()) }}</td>
                    <td colspan="2"></td>
                </tr>
            </ng-template>
        </p-table>
    </p-card>

    <!-- Year-End Bonus Summary for non-bonus employees -->
    <p-card styleClass="year-end-summary-card mt-3" *ngIf="filteredEmployees.length > 0">
        <ng-template pTemplate="header">
            <div class="year-end-card-header">
                <i class="pi pi-calendar-plus"></i>
                <span>Year-End Bonus Summary — {{ currentYear }}</span>
                <p-badge [value]="'Formula: (Total Year Salary / 100) × 16.66'" severity="warn" styleClass="formula-badge"></p-badge>
            </div>
        </ng-template>
        <div class="year-end-summary-grid">
            <ng-container *ngFor="let emp of filteredEmployees">
                <div class="year-end-emp-card" *ngIf="!emp.isBonused">
                    <div class="emp-card-name">
                        <i class="pi pi-user"></i> {{ emp.name }}
                    </div>
                    <div class="emp-card-stats">
                        <div class="emp-stat">
                            <span class="stat-lbl">YTD Salary</span>
                            <span class="stat-val">{{ formatCurrency(getYearToDateSalary(emp)) }}</span>
                        </div>
                        <div class="emp-stat bonus-stat">
                            <span class="stat-lbl">Year-End Bonus</span>
                            <span class="stat-val bonus-val">{{ formatCurrency(getYearEndBonus(emp)) }}</span>
                        </div>
                    </div>
                </div>
            </ng-container>
            <div *ngIf="getNonBonusedCount() === 0" class="no-year-end">
                <i class="pi pi-info-circle"></i> All employees in this branch receive per-salary bonuses.
            </div>
        </div>
    </p-card>
</div>

<p-dialog header="Process Salary" [(visible)]="displayViewDialog" [modal]="true" [style]="{ width: '70vw' }" [breakpoints]="{ '960px': '75vw', '640px': '100vw', '480px': '100vw' }" [draggable]="false" [resizable]="false" styleClass="view-employee-dialog">
    <app-pay-salary></app-pay-salary>
</p-dialog>

<p-dialog header="Process Expenses" [(visible)]="displayExpenseViewDialog" [modal]="true" [style]="{ width: '70vw' }" [breakpoints]="{ '960px': '75vw', '640px': '100vw', '480px': '100vw' }" [draggable]="false" [resizable]="false" styleClass="view-employee-dialog">
    <app-add-expense (saved)="onExpenseSaved()"></app-add-expense>
</p-dialog>
